name: EAS Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps --prefer-offline --no-audit --progress=false
      
    - name: Setup Expo CLI
      run: npm install -g @expo/cli eas-cli
      
    - name: Create app.json for EAS
      run: |
        cat > app.json << 'EOF'
        {
          "expo": {
            "name": "GhostBridge",
            "slug": "ghostbridge-app",
            "version": "1.0.0",
            "platforms": ["android"],
            "android": {
              "package": "com.ghostbridgeapp",
              "versionCode": 1,
              "compileSdkVersion": 35,
              "targetSdkVersion": 35,
              "buildToolsVersion": "35.0.0"
            },
            "plugins": [
              [
                "expo-build-properties",
                {
                  "android": {
                    "compileSdkVersion": 35,
                    "targetSdkVersion": 35,
                    "buildToolsVersion": "35.0.0"
                  }
                }
              ]
            ]
          }
        }
        EOF
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ghostbridge-apk
        path: "*.apk"
        retention-days: 30
